<!doctype html>
<html lang="en">
<head>
    <meta charset="utf-8"/>
    <title>CODA Demo – Endpoint Tester</title>
    <meta name="viewport" content="width=device-width, initial-scale=1"/>
    <style>
        :root {
            --fg: #1b1f23;
            --bg: #fff;
            --muted: #6a737d;
            --accent: #2563eb;
            --ok: #16a34a;
            --err: #dc2626;
        }

        * {
            box-sizing: border-box;
        }

        body {
            font-family: system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial, sans-serif;
            margin: 0;
            color: var(--fg);
            background: var(--bg);
        }

        header {
            padding: 18px 20px;
            border-bottom: 1px solid #eee;
            display: flex;
            align-items: center;
            gap: 12px;
            flex-wrap: wrap;
        }

        header h1 {
            margin: 0;
            font-size: 18px;
        }

        header .links a {
            color: var(--accent);
            text-decoration: none;
            margin-right: 12px;
        }

        main {
            padding: 16px;
            max-width: 1100px;
            margin: 0 auto;
        }

        section {
            border: 1px solid #eee;
            border-radius: 12px;
            padding: 16px;
            margin: 16px 0;
        }

        h2 {
            margin: 0 0 12px 0;
            font-size: 16px;
        }

        label {
            font-size: 12px;
            color: var(--muted);
            display: block;
            margin-top: 8px;
        }

        input, textarea {
            width: 100%;
            padding: 10px;
            border: 1px solid #e5e7eb;
            border-radius: 8px;
            font-family: inherit;
            font-size: 14px;
        }

        textarea {
            min-height: 120px;
        }

        .row {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 8px;
        }

        .btns {
            display: flex;
            gap: 8px;
            margin-top: 10px;
            flex-wrap: wrap;
        }

        button, a.btn {
            background: var(--accent);
            color: #fff;
            border: none;
            padding: 10px 12px;
            border-radius: 10px;
            cursor: pointer;
            font-weight: 600;
            text-decoration: none;
            display: inline-flex;
            align-items: center;
            gap: 6px;
        }

        button.secondary {
            background: #111827;
        }

        button.ghost {
            background: #fff;
            color: var(--accent);
            border: 1px solid var(--accent);
        }

        pre {
            background: #0b1020;
            color: #e5e7eb;
            padding: 12px;
            border-radius: 10px;
            overflow: auto;
            max-height: 300px;
        }

        .status.ok {
            color: var(--ok);
        }

        .status.err {
            color: var(--err);
        }

        .small {
            font-size: 12px;
            color: var(--muted);
        }

        .grid-2 {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 12px;
        }
    </style>
</head>
<body>
<header>
    <h1>CODA Demo – Endpoint Tester</h1>
    <div class="links">
        <a href="/swagger-ui.html" target="_blank">Swagger UI</a>
        <a href="/v3/api-docs" target="_blank">OpenAPI JSON</a>
        <a href="/actuator/health" target="_blank">/actuator/health</a>
        <a href="/actuator/info" target="_blank">/actuator/info</a>
    </div>
</header>

<main>
    <section>
        <h2>Common inputs</h2>
        <div class="row">
            <div><label>Bank name</label><input id="bankName" value="BELFIUS"/></div>
            <div><label>Account</label><input id="account" value="BE68 5390 0754 7034"/></div>
            <div><label>Currency</label><input id="currency" value="EUR"/></div>
        </div>
        <div class="row">
            <div><label>Statement date (YYYY-MM-DD)</label><input id="date" placeholder="today if empty"/></div>
            <div><label>Opening balance</label><input id="opening" value="1200.00"/></div>
            <div><label>Download filename (for /download)</label><input id="filename" value="booking_statement"/></div>
        </div>
    </section>

    <section>
        <h2>GET /api/coda/generate (inline)</h2>
        <div class="small">Add repeatable <code>tx</code> lines (one per line):
            TYPE:YYYY-MM-DD:AMOUNT:ACCOUNT:NAME:DESC:REF
        </div>
        <textarea id="txGet">CREDIT:2025-09-03:125.00:BE12 3456 7890 1234:CLIENT X:Payment received:INV-2025-0456
DEBIT:2025-09-04:50.00:BE98 7654 3210 9876:SUPPLIER Y:SEPA transfer:INV-2025-0042</textarea>
        <div class="btns">
            <button id="btnCodaGet">Call /api/coda/generate</button>
            <button class="ghost" id="btnCodaGetBad">Call /api/coda/generate (bad tx)</button>
            <a class="btn secondary" id="btnCodaGetOpen" href="#" target="_blank">Open in new tab</a>
        </div>
        <div class="small">Status: <span id="statusCodaGet" class="status"></span></div>
        <pre id="outCodaGet"></pre>
    </section>

    <section>
        <h2>GET /api/coda/download (attachment)</h2>
        <div class="btns">
            <a class="btn" id="btnCodaDownload" href="#" download>Download file</a>
        </div>
        <div class="small">Click to trigger a browser download using your inputs.</div>
    </section>

    <section>
        <h2>POST /api/coda/json (inline) &nbsp; /api/coda/json/download (attachment)</h2>
        <div class="grid-2">
            <div>
                <label>JSON body</label>
                <textarea id="jsonBody">{
  "bankName": "BELFIUS",
  "account": "BE68 5390 0754 7034",
  "currency": "EUR",
  "date": "2025-09-03",
  "opening": 1200.00,
  "transactions": [
    {
      "bookingDate": "2025-09-03",
      "type": "CREDIT",
      "amount": 125.00,
      "counterpartyName": "CLIENT X",
      "counterpartyAccount": "BE12 3456 7890 1234",
      "description": "Payment received",
      "reference": "INV-2025-0456"
    },
    {
      "bookingDate": "2025-09-04",
      "type": "DEBIT",
      "amount": 50.00,
      "counterpartyName": "SUPPLIER Y",
      "counterpartyAccount": "BE98 7654 3210 9876",
      "description": "SEPA transfer",
      "reference": "INV-2025-0042"
    }
  ]
}</textarea>
                <div class="btns">
                    <button id="btnJsonInline">POST /api/coda/json</button>
                    <button class="secondary" id="btnJsonDownload">POST /api/coda/json/download</button>
                </div>
            </div>
            <div>
                <label>Response</label>
                <pre id="outJson"></pre>
            </div>
        </div>
    </section>

</main>

<script>
    const $ = (id) => document.getElementById(id);

    function buildCodaUrl(download = false) {
        const bankName = encodeURIComponent($('bankName').value || 'BELFIUS');
        const account = encodeURIComponent($('account').value || 'BE68 5390 0754 7034');
        const currency = encodeURIComponent($('currency').value || 'EUR');
        const date = $('date').value ? '&date=' + encodeURIComponent($('date').value) : '';
        const opening = encodeURIComponent($('opening').value || '1200.00');
        const txLines = ($('txGet').value || '').split('\\n').map(s => s.trim()).filter(Boolean)
            .map(v => '&tx=' + encodeURIComponent(v)).join('');
        const basePath = download ? '/api/coda/download' : '/api/coda/generate';
        const fn = $('filename').value ? '&filename=' + encodeURIComponent($('filename').value) : '';
        return `${basePath}?bankName=${bankName}&account=${account}&currency=${currency}${date}&opening=${opening}${txLines}${download ? fn : ''}`;
    }

    $('btnCodaGet').onclick = async () => {
        const url = buildCodaUrl(false);
        $('btnCodaGetOpen').href = url;
        try {
            const res = await fetch(url, {headers: {'Accept': 'text/plain'}});
            $('statusCodaGet').textContent = res.status + ' ' + res.statusText;
            $('statusCodaGet').className = 'status ' + (res.ok ? 'ok' : 'err');
            $('outCodaGet').textContent = await res.text();
        } catch (e) {
            $('statusCodaGet').textContent = 'ERROR';
            $('statusCodaGet').className = 'status err';
            $('outCodaGet').textContent = e.message || String(e);
        }
    };

    $('btnCodaGetBad').onclick = async () => {
        const url = '/api/coda/generate?tx=' + encodeURIComponent('CREDITT:2025-09-03:125.00:BE12 3456 7890 1234:CLIENT X:Payment:INV-1');
        const res = await fetch(url, {headers: {'Accept': 'application/json'}});
        $('statusCodaGet').textContent = res.status + ' ' + res.statusText;
        $('statusCodaGet').className = 'status ' + (res.ok ? 'ok' : 'err');
        $('outCodaGet').textContent = await res.text();
    };

    $('btnCodaDownload').onclick = (e) => {
        e.target.href = buildCodaUrl(true);
    };

    $('btnJsonInline').onclick = async () => {
        const body = $('jsonBody').value;
        const res = await fetch('/api/coda/json', {
            method: 'POST',
            headers: {'Content-Type': 'application/json', 'Accept': 'text/plain'},
            body
        });
        $('outJson').textContent = await res.text();
    };

    $('btnJsonDownload').onclick = async () => {
        const body = $('jsonBody').value;
        const fname = $('filename').value ? ('?filename=' + encodeURIComponent($('filename').value)) : '';
        const res = await fetch('/api/coda/json/download' + fname, {
            method: 'POST',
            headers: {'Content-Type': 'application/json', 'Accept': 'text/plain'},
            body
        });
        const blob = await res.blob();
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = ($('filename').value || 'statement') + (($('filename').value || '').endsWith('.coda') ? '' : '.coda');
        document.body.appendChild(a);
        a.click();
        a.remove();
        URL.revokeObjectURL(url);
        $('outJson').textContent = 'Downloaded ' + a.download + ' (' + res.status + ' ' + res.statusText + ')';
    };

</script>
</body>
</html>
